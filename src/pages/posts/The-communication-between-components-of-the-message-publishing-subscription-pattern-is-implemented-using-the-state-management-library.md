---
layout: "../../layouts/MarkdownPost.astro"
title: "æ‰‹æ’•å‘å¸ƒè®¢é˜…æ¨¡å¼ç»„ä»¶é€šä¿¡â€”â€”åŸºäºçŠ¶æ€ç®¡ç†å®ç°"
pubDate: 2023-06-16
description: "The communication between components of the message publishing subscription pattern is implemented using the state management libraryä½¿ç”¨çŠ¶æ€ç®¡ç†åº“å®ç°æ¶ˆæ¯å‘å¸ƒè®¢é˜…æ¨¡å¼çš„ç»„ä»¶é—´é€šä¿¡åŠŸèƒ½"
author: "LunaSeki"
cover:
    url: "/cover4.jpg"
    square: "/cover4.jpg"
    alt: "cover"
tags: ["å‰ç«¯", "React", "zustand"]
theme: "light"
featured: true
---

æœ€è¿‘å†™é¡¹ç›®æ—¶çªå‘å¥‡æƒ³ï¼Œç”¨çŠ¶æ€ç®¡ç†åº“å®ç°äº†ä¸€ä¸ªæ¶ˆæ¯è®¢é˜…ä¸å‘å¸ƒçš„ hookï¼Œæ„Ÿè§‰è¿˜æŒºå¥½ç©çš„  
åŠ ä¸Š zustand è¿™ä¸ªåº“ç”¨æ³•ä¹Ÿæ¯”è¾ƒçµæ´»ï¼Œå°±é¡ºä¾¿å†™äº†ç¯‡åšå®¢ ğŸ˜†

---

## PubSub

ç›¸ä¿¡åŒå­¦ä»¬éƒ½ç”¨è¿‡ pubsub-js è¿™ä¸ªåº“ï¼Œéçˆ¶å­ç»„ä»¶ä¹‹é—´é€šè¿‡æ¶ˆæ¯å‘å¸ƒ/è®¢é˜…æ¨¡å¼é€šä¿¡å¯ä»¥ä¸ç”¨è€ƒè™‘ç»„ä»¶ä¹‹é—´çš„å…³ç³»ï¼Œè€Œæ˜¯é‡‡ç”¨å¯¹æŸä¸ªæ¶ˆæ¯åçš„è®¢é˜…ã€å‘å¸ƒçš„æ–¹å¼ä¼ é€’ä¿¡æ¯ï¼Œéå¸¸æ–¹ä¾¿ã€‚

æ¶ˆæ¯è®¢é˜…ä¸å‘å¸ƒæ¨¡å¼æœ‰ä¸‰ä¸ªä¸»è¦åŠŸèƒ½ï¼š

### æ¶ˆæ¯è®¢é˜…

ç»™ subscribe æ–¹æ³•ä¼ å…¥ä¸¤ä¸ªå‚æ•°

1. äº‹ä»¶å
2. è®¢é˜…çš„è§¦å‘å‡½æ•°ï¼Œå½“æœ‰ç›¸åŒäº‹ä»¶åçš„å‘å¸ƒæ¶ˆæ¯æ—¶è§¦å‘è¯¥å‡½æ•°

```javascript
subscribe("event-name", (props) => {
	//todos
});
```

### æ¶ˆæ¯å‘å¸ƒ

ç»™ publish æ–¹æ³•ä¼ å…¥ä¸¤ä¸ªå‚æ•°

1. äº‹ä»¶å
2. è§¦å‘è®¢é˜…äº‹ä»¶çš„å‚æ•°

```javascript
publish("event-name", psops);
```

ç®€å•çš„è¯´ï¼Œæ­¤å¤„å‘å¸ƒçš„äº‹ä»¶å¦‚æœå·²ç»è¢«è®¢é˜…è¿‡ï¼Œé‚£ä¹ˆè¿™æ¬¡å‘å¸ƒæ¶ˆæ¯æ—¶ä¼ é€’çš„å‚æ•°ä¼ ç»™è®¢é˜…çš„è§¦å‘å‡½æ•°ï¼Œå¹¶è¿è¡Œä¸€æ¬¡è§¦å‘å‡½æ•°

### å°ç»“

æœ‰ç‚¹ç»•ï¼Ÿé‚£æˆ‘ä»¬ä¸å¦¨æŠŠæ¶ˆæ¯è®¢é˜…ã€å‘å¸ƒæ¨¡å¼å½“æˆè®¢é˜…æŠ¥çº¸è¯•è¯•

æ¯”å¦‚ä¸‹é¢è¿™å¼ å›¾ï¼Œæœ‰ä¸‰ä¸ªè®¢é˜…è€…å»æŠ¥ç¤¾è®¢é˜…æŠ¥çº¸  
![subscribe](https://s2.loli.net/2023/06/15/H9uIxte6Y3851Ej.png)  
è®¢é˜…æŠ¥çº¸çš„æ—¶å€™è®¢é˜…è€…è¦å‘æŠ¥ç¤¾è¯´æ˜è¦è®¢å“ªä¸€ä»½**æŠ¥çº¸**ï¼ˆå¯¹åº”äº‹ä»¶åï¼‰ï¼Œè¿˜æœ‰è‡ªå·±çš„**åœ°å€**ï¼ˆè®¢é˜…äº‹ä»¶ï¼‰ï¼Œæ–¹ä¾¿æŠ¥ç¤¾å°†æŠ¥çº¸é€ç»™è‡ªå·±

æ¥ä¸‹æ¥ï¼Œå½“æœ‰äººæƒ³å‘å¸ƒæ¶ˆæ¯æ—¶ï¼Œå°±ä¼šå»æŠ¥ç¤¾åˆŠç™»æ¶ˆæ¯
![publish](https://s2.loli.net/2023/06/15/lcMxo6D5IfZdvVw.png)  
æ¯”å¦‚å›¾ä¸­çš„å‘å¸ƒè€…ï¼Œé€‰æ‹©åœ¨â€œB æ—¥æŠ¥â€ä¸Šå‘å¸ƒâ€œä¿¡æ¯ 1â€ï¼Œé‚£ä¹ˆæŠ¥ç¤¾ä¼šå°†â€œä¿¡æ¯ 1â€åˆŠç™»åœ¨â€œB æ—¥æŠ¥â€ä¸Šï¼Œå¹¶æ ¹æ®è®¢é˜…è€…é¢„ç•™çš„åœ°å€ï¼Œå°†è¯¥ä¿¡æ¯é€åˆ°è®¢é˜…äº†è¿™ä»½æŠ¥çº¸çš„è®¢é˜…è€…æ‰‹ä¸Šï¼ˆå¯¹åº”æ¶ˆæ¯å‘å¸ƒæ—¶ä¼šå°†**å‘å¸ƒ**æ—¶æºå¸¦**çš„æ•°æ®**ä½œä¸ºå‚æ•°**ä¼ å…¥**æ¯ä¸ª**è®¢é˜…**ä¼ å…¥**çš„å‡½æ•°**ï¼‰

å¾ˆç®€å•å§ï¼Œæ— è®ºæœ‰å¤šå°‘ä¸ªè®¢é˜…è€…è®¢é˜…äº†åŒä¸€ä»½æŠ¥çº¸ï¼Œåªè¦æœ‰äººå‘å¸ƒæ¶ˆæ¯ï¼Œé‚£ä¹ˆæŠ¥ç¤¾å°±ä¼šå°†è¿™ä»½æ¶ˆæ¯ä¼ é€’åˆ°æ¯ä¸€ä¸ªè®¢é˜…è€…æ‰‹ä¸Š

### unsubscribe

èƒ½å¤Ÿè®¢é˜…æ¶ˆæ¯ï¼Œè‡ªç„¶ä¹Ÿèƒ½å¤Ÿå–æ¶ˆè®¢é˜…ï¼Œæ¯•ç«Ÿä¸å–æ¶ˆè®¢é˜…ï¼Œæ¯æ¬¡æœ‰æ–°ä¿¡æ¯å°±ä¼šè¢«æ‰“æ‰°ï¼Œè‚¯å®šæ˜¯ä¸è¡Œçš„~~

```javascript
unsubscribe(token);
```

è¿™é‡Œçš„ token æ˜¯è®¢é˜…çš„æ—¶å€™è¿”å›çš„ä¸€ä¸ªæ ‡è¯†ï¼Œç”¨äºå”¯ä¸€åœ°æ ‡è¯†å½“å‰è¿™ä¸ªè®¢é˜…ï¼Œè¿™æ ·åœ¨å–æ¶ˆè®¢é˜…æ—¶ç›´æ¥ä¼ å…¥è¿™ä¸ª token å°±è¡Œäº†

## å®ç°åŸç†

é€šè¿‡ä¸Šé¢çš„æ ·ä¾‹æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“æ¨å‡ºï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®¹å™¨æ¥å­˜å‚¨ä¸åŒçš„**æ¶ˆæ¯**å’Œæ¯ä¸ªæ¶ˆæ¯å¯¹åº”çš„è‹¥å¹²ä¸ª**è®¢é˜…äº‹ä»¶**ã€‚  
è¿™æ ·ï¼Œå½“æ¶ˆæ¯å‘å¸ƒæ—¶å°±å¯ä»¥å»æ‰¾å¯¹åº”çš„æ¶ˆæ¯ï¼Œå°†è¯¥æ¶ˆæ¯çš„äº‹ä»¶é€ä¸ªè¿è¡Œå°±è¡Œäº†

### æ¶ˆæ¯çš„å­˜å‚¨

é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å­˜å‚¨æ¶ˆæ¯å‘¢ï¼Ÿ  
åœ¨ js ä¸­ï¼Œæœ€åˆé€‚çš„å­˜å‚¨ç»“æ„åº”è¯¥å°±æ˜¯å¯¹è±¡äº†å§ï¼Œkey å€¼ä¸ºæ¶ˆæ¯åï¼Œvalue å°±å¯ä»¥ç”¨æ¥å­˜å‚¨äº‹ä»¶ï¼Œä¾‹å¦‚

```javascript
{
    message1: events,
    message2: events,
    message3: events,
    // ...
}
```

### äº‹ä»¶çš„å­˜å‚¨

ç”±äºä¸€ä¸ªæ¶ˆæ¯å¯èƒ½å­˜åœ¨å¤šä¸ªè®¢é˜…ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ•°ç»„æ¥å­˜å‚¨ï¼Œè¿­ä»£æ•°ç»„å³å¯è¿è¡Œäº‹ä»¶

æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨é“¾è¡¨æ¥å­˜å‚¨äº‹ä»¶ï¼Œæ¯ä¸ªäº‹ä»¶é‡Œæœ‰ä¸€ä¸ª function å­˜å‚¨è®¢é˜…çš„å‡½æ•°ï¼Œè¿˜æœ‰ä¸€ä¸ª next å­˜å‚¨ä¸‹ä¸€ä¸ªäº‹ä»¶ï¼Œè¿™æ ·çš„è¯æ¯ä¸ªäº‹ä»¶é‡Œåªéœ€å­˜å‚¨ç¬¬ä¸€ä¸ªäº‹ä»¶å°±èƒ½å¤Ÿéå†å‰©ä¸‹çš„æ‰€æœ‰äº‹ä»¶äº†  
![é“¾è¡¨](https://s2.loli.net/2023/06/15/V1Pj5OxF937AKtp.png)

### æ¶ˆæ¯å‘å¸ƒæµç¨‹

ç»è¿‡ä¸Šè¿°è¿‡ç¨‹ï¼Œè®¢é˜…çš„äº‹ä»¶å·²ç»å­˜å‚¨åœ¨å¯¹è±¡çš„ value ä¸­äº†  
å½“æœ‰äº‹ä»¶å‘å¸ƒæ—¶ï¼Œæˆ‘ä»¬å…ˆç”¨äº‹ä»¶åå»å¯»æ‰¾å¯¹è±¡ä¸­æœ‰æ— å¯¹åº”çš„ keyï¼Œå¦‚æœæœ‰åˆ™éå†è¿™ä¸ª key å¯¹åº”çš„ value ä¸­çš„äº‹ä»¶

æ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿä½†æ˜¯ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜â€”â€”æ€ä¹ˆä¿è¯ç»„ä»¶é—´å…±ç”¨ä¸€ä¸ªâ€œæŠ¥ç¤¾â€å‘¢ï¼Ÿ

### è·¨ç»„ä»¶é€šä¿¡

åœ¨ä¸»æµçš„å‰ç«¯æ¡†æ¶ä¸­ï¼ŒæŠŠç»„ä»¶æ¨¡å—åŒ–æ˜¯å¾ˆå¸¸è§çš„åšæ³•ï¼Œå¦‚æœæˆ‘ä»¬åªæ˜¯ç®€å•æŠŠä¸Šé¢çš„åŠŸèƒ½å®ç°æˆç®€å•çš„ hookï¼Œå¹¶ä¸èƒ½ææä¾›ç»„ä»¶é—´çš„é€šä¿¡ï¼Œå› ä¸ºæ¯ä¸ªç»„ä»¶è°ƒç”¨ hook è·å–çš„éƒ½æ˜¯ç‹¬ç«‹çš„æ•°æ®ï¼Œä¸èƒ½å®ç°ç»„ä»¶é—´é€šä¿¡çš„è¦æ±‚  
æ¯”å¦‚ç»„ä»¶ A è°ƒç”¨ä¸€ä¸ª hookï¼Œç»„ä»¶ B è°ƒç”¨åŒä¸€ä¸ª hookï¼Œæ­¤æ—¶ Aã€B ç»„ä»¶çš„æ•°æ®æ˜¯å„è‡ªç‹¬ç«‹çš„ï¼ˆä¸€èˆ¬æ¥è¯´ï¼‰ï¼ŒA ä¿®æ”¹äº†å…¶ä¸­çš„æ•°æ® B ä¹Ÿä¸èƒ½è¯»å–åˆ°

ä»”ç»†çœ‹çœ‹éœ€æ±‚ï¼Œæˆ‘ä»¬å°±èƒ½çŸ¥é“â€”â€”æˆ‘ä»¬éœ€è¦ä¸€ä¸ª**å•ä¾‹æ¨¡å¼**çš„å®¹å™¨å¸®åŠ©æˆ‘ä»¬å­˜å‚¨äº‹ä»¶ï¼Œå¹¶æä¾›ç»™æ¯ä¸ªç»„ä»¶è®¿é—®ï¼

å•ä¾‹æ¨¡å¼èƒ½å¤Ÿä¿è¯ä¸åŒç»„ä»¶è®¿é—®çš„â€œå®¹å™¨ç©ºé—´â€æ˜¯åŒä¸€ä¸ªï¼Œå³ç»„ä»¶ Aã€ç»„ä»¶ B éƒ½å¯¹åŒä¸€ä¸ªç©ºé—´é‡Œçš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œä»è€Œå®ç°é€šä¿¡åŠŸèƒ½  
é‚£ä¹ˆè¿™ä¸ªä¸œè¥¿åœ¨å“ªå‘¢ï¼Ÿ

å…¶å®åœ¨ Vue2 é‡Œï¼Œé‚£ä¸ªæŒ‚è½½åˆ° Vue ä¸Šçš„äº‹ä»¶æ€»çº¿ï¼ˆbusï¼‰å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œä¸åŒçš„ç»„ä»¶éƒ½èƒ½å¤Ÿä» Vue ä¸Šè·å–åˆ°äº‹ä»¶æ€»çº¿å¹¶ä¸ä¹‹é€šä¿¡  
ä½†æ˜¯åœ¨ Vue3 æˆ–è€… React18 é‡Œï¼ŒæŒ‚è½½åˆ°ä¸€ä¸ªå…¨å±€éƒ½èƒ½è®¿é—®çš„åœ°æ–¹ä¹Ÿä¸å¤ªæ–¹ä¾¿ï¼Œé‚£æˆ‘ä»¬ä¸å¦¨è€ƒè™‘æŠŠäº‹ä»¶æ”¾åˆ°åŒä¸ºå•ä¾‹æ¨¡å¼çš„**çŠ¶æ€ç®¡ç†**ç»„ä»¶ä¸Š

## ç”¨ Zustand å®ç°æ¶ˆæ¯è®¢é˜…/å‘å¸ƒ

è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ React18 ä»¥åŠä¸€ä¸ªçŠ¶æ€ç®¡ç†åº“ Zustand å®ç°çš„ï¼Œzustand æ˜¯ä¸€ä¸ªæ¯”è¾ƒè½»ï¼ˆä¸ªäººæ„Ÿè§‰ï¼‰çš„çŠ¶æ€ç®¡ç†åº“ï¼Œæ¯”è¾ƒé€‚åˆæ•°æ®ä¸ç®—å¤æ‚çš„åœºæ™¯ï¼Œéå¸¸çš„çµæ´»

### åŸºæœ¬ç”¨æ³•

ç®€å•è®²ä¸€ä¸‹ zustand çš„åŸºæœ¬ç”¨æ³•ï¼Œè¯¦ç»†çš„å¯ä»¥å»çœ‹çœ‹æ–‡æ¡£ï¼ŒæŒºç®€å•çš„

å…ˆåˆ›å»ºä¸€ä¸ª useStore æ–‡ä»¶ï¼Œä½¿ç”¨ zustand çš„ create æ–¹æ³•å³å¯åˆ›å»ºä¸€ä¸ªçŠ¶æ€ç®¡ç† hook

```javascript
// useStore.ts
import { create } from "zustand";

const useStore = create((set, get) => ({
    val1:1;
    val2:"abc"
    changeVal1: (newVal1)=>{
        set(()=>{val1:newVal1})
        }
    getVal2: ()=>{
        return get().val2;
    }
}));

export default useStore;
```

å¯ä»¥çœ‹åˆ°ï¼Œç»™ create ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥å—ä¸¤ä¸ªæ–¹æ³• set å’Œ get

-   set ç”¨äºç»™**çŠ¶æ€ä¸­çš„æ–¹æ³•**æä¾›ä¿®æ”¹**çŠ¶æ€ä¸­çš„æ•°æ®**çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ changeVal1 é‡Œå°±ä½¿ç”¨äº† set ä¿®æ”¹äº† val1 çš„æ•°æ®
-   get ç”¨äºç»™**çŠ¶æ€ä¸­çš„æ–¹æ³•**æä¾›è·å–**çŠ¶æ€ä¸­çš„æ•°æ®**çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ getVal2 é‡Œå°±ä½¿ç”¨äº† get è·å–åˆ° val2 çš„æ•°æ®

è¿™æ ·ï¼Œåœ¨å…¶ä»–ç»„ä»¶ä¸­åƒæ­£å¸¸çš„ hook ä¸€æ ·è°ƒç”¨å°±è¡Œ

```javascript
import useStore from "useStore";
const component = () => {
	const changeValue1 = useStore((state) => state.changeVal1);
	const getVal2 = useStore((state) => state.getVal2);
};
```

è¿™æ ·å°±èƒ½å¤Ÿè·å–åˆ°çŠ¶æ€ä¸­çš„æ•°æ®äº†ï¼Œè€Œä¸”ç”±äºçŠ¶æ€ç®¡ç†åº“çš„ç‰¹æ€§ï¼Œæ¯ä¸ªç»„ä»¶è¯»å–åˆ°çš„æ•°æ®æ˜¯å…±ç”¨çš„

é‚£ä¹ˆæ¥ä¸‹æ¥å°±å¯ä»¥åœ¨ zustand ä¸Šå®ç°çŠ¶æ€ç®¡ç†äº†

### ç±»å‹å®šä¹‰

è¿™é‡Œé€‰ç”¨å•é“¾è¿›è¡Œè®¢é˜…äº‹ä»¶çš„å­˜å‚¨ï¼Œä½ å¯ä»¥è¯•è¯•ç”¨æ•°ç»„å®ç°

æˆ‘ä»¬å…ˆå¯¹äº‹ä»¶è¿›è¡Œå®šä¹‰ï¼Œå…¶ä¸­ func æ˜¯è®¢é˜…æ—¶ä¼ å…¥çš„å‡½æ•°ï¼Œnext æ˜¯ä¸‹ä¸€ä¸ªäº‹ä»¶

```typescript
interface Event {
	func: Function;
	next: Event | null;
}
```

ç„¶åå®šä¹‰å‚¨å­˜ä¸åŒè®¢é˜…äº‹ä»¶çš„å¯¹è±¡ï¼Œå…¶ä¸­äº‹ä»¶åä¸ºå­—ç¬¦ä¸²å½¢å¼ï¼Œè€Œ value å°±æ˜¯ä¸Šé¢çš„ Event äº†

```typescript
interface Events {
	[event: string]: Event;
}
```

æœ€åï¼Œæˆ‘ä»¬å†å®šä¹‰çŠ¶æ€çš„ç±»å‹ï¼Œevents å°±æ˜¯ä¸Šé¢çš„äº‹ä»¶å­˜å‚¨å¯¹è±¡ï¼Œå†å®šä¹‰ä¸‰ä¸ªæ“ä½œäº‹ä»¶çš„æ–¹æ³•ï¼ˆæ–¹æ³•ç±»å‹å¯ä»¥å…ˆå†™å®Œå‡½æ•°å†å®šä¹‰å°±æ¯”è¾ƒæ–¹ä¾¿ï¼‰ï¼Œç±»å‹å®šä¹‰å°±å®Œæˆäº†

```typescript
interface PubSubStore {
	events: Events;
	subscribe: (mes: string, func: Function) => void;
	publish: (mes: string, args: Array<any>) => void;
	unSubscribe: (mes: string, func: Function) => void;
}
```

### åˆ›å»ºçŠ¶æ€

ä»£ç ä¸å¤ªå¥½åˆ†å¼€è®²ï¼Œè¿™é‡Œå…ˆæŠŠå®é™…ä»£ç æ”¾ä¸Šæ¥

```typescript
// useEvents.ts
...
const useEvents = create<PubSubStore>((set, get) => ({
	events: {},
	subscribe: (mes, func) => {
        // å½“æœ‰æ–°è®¢é˜…æ—¶ï¼Œå…ˆå°è£…ä¸€ä¸ªäº‹ä»¶çš„å¯¹è±¡
		let newSub: Event = {
			func,
			next: null,
		};
		let events = get().events;
        // å¦‚æœæ¶ˆæ¯çš„äº‹ä»¶ä¸ºç©ºï¼Œåˆ™ç›´æ¥æ’å…¥å°±è¡Œ
		if (!events[mes]) events[mes] = newSub;
        // äº‹ä»¶ä¸ä¸ºç©ºï¼Œéå†å•é“¾ï¼ŒæŠŠäº‹ä»¶æ’å…¥åˆ°é“¾è¡¨å°¾éƒ¨
		else {
			let event = events[mes];
			let firstEvent = event;
			while (event.next) {
				event = event.next;
			}
			event.next = newSub;
			events[mes] = firstEvent;
		}
		set(() => ({ events: events }));
	},
	publish: (mes, args) => {â€˜
    // æ¶ˆæ¯å‘å¸ƒï¼Œå…ˆè·å–æ¶ˆæ¯çš„äº‹ä»¶
		let events = get().events;
		if (!events[mes]) return;
		let event: Event | null = events[mes];
        // éå†æ‰€æœ‰äº‹ä»¶
		while (event != null) {
            // å¼‚å¸¸æ•è·ï¼Œé˜²æ­¢ä¼ å‚ä¸æ­£ç¡®å‡ºé—®é¢˜
			try {
				event.func(...args);
			} catch (e) {
				console.log("public error", mes, event.func, args);
			}
			event = event.next;
		}
	},
	unSubscribe: (mes, func) => {
        // åˆ é™¤è®¢é˜…ï¼Œä¹Ÿæ˜¯éå†æ‰€æœ‰äº‹ä»¶
		let events = get().events;
		if (!events[mes]) return;
		let event: Event | null = events[mes];
		while (event && Object.is(event.func, func)) {
			event = event.next;
		}
		let firstEvent = event;
		let next = event?.next || null;
        // éå†é“¾è¡¨ï¼Œæ¯”è¾ƒäº‹ä»¶
		while (next != null) {
			if (Object.is(next.func, func)) {
				// è¿™é‡Œå¯ä»¥ä½¿ç”¨æ–­è¨€ï¼Œå› ä¸ºnextä¸ä¸ºnullæ—¶eventå¿…ç„¶ä¸ä¸ºnull
				next = next.next;
				event!.next = next;
			}
			event = next;
			next = next?.next || null;
		}
		if (!firstEvent) {
			delete events[mes];
		} else events[mes] = firstEvent;
		set(() => ({
			events: events,
		}));
	},
}));
...
```

å†™çš„æœ‰ç‚¹çƒ‚ï¼Œä¸è¿‡å¤§æ¦‚åŠŸèƒ½è¿˜æ˜¯å®ç°äº†

ä¸»è¦åŠŸèƒ½æ˜¯ç»´æŠ¤ä¸€ä¸ª events å¯¹è±¡ï¼Œå½“æœ‰äº‹ä»¶è®¢é˜…æ—¶ï¼ŒæŠŠè®¢é˜…çš„å›è°ƒæ”¾åˆ°å¯¹åº”äº‹ä»¶çš„é“¾è¡¨ä¸Š  
å½“æœ‰æ¶ˆæ¯å‘å¸ƒæ—¶ï¼Œå¯¹é“¾è¡¨è¿›è¡Œéå†å¹¶è°ƒç”¨ï¼Œè¿™é‡Œè¿˜åšäº†ä¸ªå¼‚å¸¸æ•è·ï¼Œé˜²æ­¢æŠ¥é”™æ‰¾ä¸åˆ°åŸå› åœ¨å“ª  
æœ€åå°±æ˜¯å–æ¶ˆè®¢é˜…æ—¶ï¼Œå¯¹æŒ‡å®šäº‹ä»¶ä¸Šçš„é“¾è¡¨è¿›è¡Œè°ƒç”¨ï¼Œç¢°åˆ°ç›¸åŒçš„å›è°ƒå°±åˆ é™¤

è¿™é‡Œå€¼å¾—è®²ä¸€ä¸‹ï¼Œç”±äºä¸ºäº†å·æ‡’å°±æ²¡ä¸ºæ¯æ¬¡è®¢é˜…ç”Ÿæˆ tokenï¼Œæ‰€ä»¥åˆ é™¤çš„æ—¶å€™å°±ä¸èƒ½é€šè¿‡ token åˆ é™¤äº†ï¼Œåªèƒ½ä¼ å…¥**åŸå‡½æ•°**è¿›è¡Œåˆ é™¤

ä¸ºä»€ä¹ˆå¼ºè°ƒ**åŸå‡½æ•°**å‘¢ï¼Œæ˜¯å› ä¸ºæˆ‘ä½¿ç”¨äº†`Object.is()`æ–¹æ³•æ¯”è¾ƒä¸¤ä¸ªå‡½æ•°æ˜¯å¦ç›¸ç­‰ï¼ˆReact çš„å‰¯ä½œç”¨åŒæ¬¾åˆ¤æ–­æ¡ä»¶ï¼‰ï¼Œè¿™ä¸ªæ¯”è¾ƒæ–¹æ³•åªä¼šå¯¹åŒä¸€ä¸ªå¼•ç”¨çš„ä¸¤ä¸ªå¯¹è±¡è¿”å› trueï¼Œæ‰€ä»¥å¤§å®¶ä½¿ç”¨çš„æ—¶å€™è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

1. åœ¨ç»„ä»¶å†…æ™®é€šå†™çš„æ–¹æ³•åœ¨ç»„ä»¶æ›´æ–°å‰åä¸æ˜¯åŒä¸€ä¸ªå‡½æ•°
2. å¯ä»¥å†™åœ¨ç»„ä»¶å¤–é¢ï¼Œè¿™æ ·ç»„ä»¶æ›´æ–°å‰åè¿˜æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯è¿™æ ·ä¸æ–¹ä¾¿å¯¹ç»„ä»¶ä¸­çš„æ•°æ®è¿›è¡Œæ“ä½œ
3. æ—¢ç„¶æ˜¯ React å‰¯ä½œç”¨åŒæ¬¾æ¯”è¾ƒæ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥é‡‡ç”¨ React çš„åŒæ¬¾æ–¹æ¡ˆå¯¹å‡½æ•°è¿›è¡Œç¼“å­˜å³å¯ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨`useCallback`æŠŠå‡½æ•°åŒ…è£¹ï¼Œè¿™æ ·è®¢é˜…çš„æ›´æ–°å°±ä¸ä¼šå¤ªé¢‘ç¹äº†
4. æ— è®ºå¦‚ä½•ï¼Œäº‹ä»¶çš„è®¢é˜…ä¸å–æ¶ˆè®¢é˜…éœ€è¦æˆå¯¹åœ°å‡ºç°åœ¨å‰¯ä½œç”¨ä¸­ï¼Œä¸ç„¶å°±å¤§æ¦‚ç‡ä¼šå‡ºç°é—®é¢˜  
   åŸå› æ˜¯å†™åœ¨`useEffect`ä¸­çš„è¯æœ‰è®¢é˜…å¿…ç„¶æœ‰å–æ¶ˆè®¢é˜…ï¼Œä¸ä¼šå †ç§¯ä¸€å †æœªå–æ¶ˆçš„å†—ä½™è®¢é˜…ï¼Œè€Œä¸”é™åˆ¶äº†è®¢é˜…çš„é¢‘ç‡ï¼Œå¦‚æœç›´æ¥å†™åœ¨ç»„ä»¶ä¸­ï¼Œé‚£ä¹ˆæ¯æ¬¡æ›´æ–°éƒ½ä¼šäº§ç”Ÿä¸€æ¬¡è®¢é˜…ï¼Œéå¸¸çš„ä¸è§„èŒƒ

### ä½¿ç”¨ç¤ºä¾‹

æœ‰äº† useEventsï¼Œé‚£æˆ‘ä»¬å°±èƒ½å¤Ÿåœ¨ç»„ä»¶é‡Œä½¿ç”¨äº†

é¦–å…ˆæ˜¯è®¢é˜…äº‹ä»¶ç»„ä»¶

```tsx
import { useEffect, useCallback, useState } from "react";
import useEvents from "useEvents";

const Component1 = () => {
	const [count, setCount] = useState(0);
	const add = useCallback(
		(num) => {
			setCount((count) => count + num);
		},
		[setCount]
	);
	const subEvent = useEvents((state) => state.subscribe);
	const unSubEvent = useEvents((state) => state.unSubscribe);
	useEffect(() => {
		subEvent("add", add);
		return () => {
			unSubEvent("add", add);
		};
	}, [add]);
	return <div>{count}</div>;
};
```

ç„¶åæ˜¯å‘å¸ƒäº‹ä»¶çš„ç»„ä»¶

```tsx
import { useEffect, useCallback, useState } from "react";
import useEvents from "useEvents";

const Component2 = () => {
	const pubEvent = useEvents((state) => state.publish);
	const add = () => {
		pubEvent("add", [1]);
	};
	return <input type='button' value='add' onClock={add} />;
};
```

å½“æŒ‰é’®è¢«ç‚¹å‡»çš„æ—¶å€™ï¼Œå°±ä¼šé€šçŸ¥è®¢é˜…çš„ç»„ä»¶ "add" 1ï¼Œå®ç°äº†ä¸€ä¸ªæ¶ˆæ¯è®¢é˜…/å‘å¸ƒçš„æµç¨‹

---

å†™çš„æœ‰ç‚¹ç³™äº†ï¼Œä¸è¿‡é¡¹ç›®é‡Œç”¨èµ·æ¥æ²¡å•¥é—®é¢˜ ğŸ¤£
